<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Master Calendar Dashboard (Shared)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #3f3f46;
        }
        .tab-button.active {
            border-color: #f59e0b;
            color: #b45309;
            background-color: #fffbeb;
        }
        .modal {
            display: none;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            display: flex;
        }
        .calendar-day.has-events {
            background-color: #fffbeb;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-amber-800">Content Master Calendar</h1>
            <p class="text-lg text-stone-600 mt-1">Dasbor terpusat untuk merencanakan, mengelola, dan menganalisis konten Anda.</p>
        </header>

        <!-- Bagian UI (HTML) tidak berubah -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <h2 class="text-lg font-semibold text-stone-700 mb-2">Waktu Saat Ini</h2>
                <div id="digital-clock" class="text-4xl font-bold text-amber-700"></div>
                <p class="text-sm text-stone-500" id="date-today"></p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <h2 class="text-lg font-semibold text-stone-700 mb-2">Postingan Hari Ini</h2>
                <div id="today-post-count" class="text-4xl font-bold text-emerald-600">0</div>
                <p class="text-sm text-stone-500">konten perlu diunggah.</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <h2 class="text-lg font-semibold text-stone-700 mb-2">Jadwal Mendatang</h2>
                <div id="upcoming-post-count" class="text-4xl font-bold text-sky-600">0</div>
                <p class="text-sm text-stone-500">konten telah direncanakan.</p>
            </div>
        </div>

        <main class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-stone-200">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div class="flex flex-wrap gap-2 border-b sm:border-b-0 pb-4 sm:pb-0 mb-4 sm:mb-0">
                    <button class="tab-button active" data-tab="calendar">üìÖ Kalender</button>
                    <button class="tab-button" data-tab="table">üìÇ Tabel Master</button>
                    <button class="tab-button" data-tab="insights">üìä Wawasan</button>
                </div>
                <button id="add-content-btn" class="w-full sm:w-auto bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    + Tambah Konten Baru
                </button>
            </div>

            <div id="tab-content">
                <div id="calendar-view" class="tab-panel">
                     <div class="text-center p-4 rounded-lg bg-amber-50 border border-amber-200 mb-4">
                        <h3 class="font-semibold text-amber-800">Perencanaan Visual Konten</h3>
                        <p class="text-sm text-amber-700">Gunakan kalender ini untuk melihat jadwal konten Anda secara keseluruhan. Klik pada tanggal untuk melihat detail atau tambahkan konten baru untuk mengisi jadwal kosong.</p>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="px-4 py-2 bg-stone-200 rounded-lg hover:bg-stone-300">‚Äπ</button>
                        <h2 id="month-year" class="text-xl font-bold"></h2>
                        <button id="next-month" class="px-4 py-2 bg-stone-200 rounded-lg hover:bg-stone-300">‚Ä∫</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>

                <div id="table-view" class="tab-panel hidden">
                    <div class="text-center p-4 rounded-lg bg-sky-50 border border-sky-200 mb-4">
                        <h3 class="font-semibold text-sky-800">Database Konten Utama</h3>
                        <p class="text-sm text-sky-700">Di sini adalah pusat semua data konten Anda. Gunakan filter untuk mencari konten spesifik, dan klik pada baris mana pun untuk melihat atau mengubah detailnya.</p>
                    </div>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <select id="platform-filter" class="border rounded-lg p-2 bg-white">
                            <option value="All">Semua Platform</option>
                        </select>
                        <select id="status-filter" class="border rounded-lg p-2 bg-white">
                             <option value="All">Semua Status</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-stone-200">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Konten</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Platform</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Tgl Upload</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="bg-white divide-y divide-stone-200">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="insights-view" class="tab-panel hidden">
                    <div class="text-center p-4 rounded-lg bg-emerald-50 border border-emerald-200 mb-6">
                        <h3 class="font-semibold text-emerald-800">Analisis & Konten Unggulan</h3>
                        <p class="text-sm text-emerald-700">Analisis performa konten Anda di sini. Lihat grafik untuk perbandingan antar platform dan jelajahi galeri konten-konten unggulan yang telah Anda tandai.</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-center">Total Insight per Platform</h3>
                            <div class="chart-container">
                                <canvas id="insights-chart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4 text-center">‚≠ê Konten Unggulan</h3>
                            <div id="featured-gallery" class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-[400px] overflow-y-auto p-2 rounded-lg bg-stone-50">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="content-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <form id="content-form" class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-amber-800" id="modal-title">Tambah Konten Baru</h2>
                    <button type="button" id="close-modal-btn" class="text-stone-500 hover:text-stone-800 text-2xl">&times;</button>
                </div>
                
                <!-- ID tidak lagi terlihat, di-handle oleh state -->
                <input type="hidden" id="content-id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="title" class="block text-sm font-medium text-stone-700">Judul Konten</label>
                        <input type="text" id="title" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="platform" class="block text-sm font-medium text-stone-700">Platform</label>
                        <select id="platform" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm"></select>
                    </div>
                    <div>
                        <label for="akun" class="block text-sm font-medium text-stone-700">Akun</label>
                        <select id="akun" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm"></select>
                    </div>
                     <div>
                        <label for="status" class="block text-sm font-medium text-stone-700">Status</label>
                        <select id="status" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm"></select>
                    </div>
                    <div>
                        <label for="tanggal-upload" class="block text-sm font-medium text-stone-700">Tanggal & Jam Upload</label>
                        <input type="datetime-local" id="tanggal-upload" required class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="file-konten" class="block text-sm font-medium text-stone-700">Link File Konten (URL Gambar)</label>
                        <input type="url" id="file-konten" placeholder="https://... (untuk preview galeri)" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm">
                    </div>
                </div>

                <div class="mt-6">
                    <label for="caption" class="block text-sm font-medium text-stone-700">Caption</label>
                    <textarea id="caption" rows="4" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm"></textarea>
                </div>
                
                <h3 class="text-lg font-semibold mt-6 mb-4 border-t pt-4">Data Performa (Opsional)</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div>
                        <label for="insight" class="block text-sm font-medium text-stone-700">Insight (Views/Likes)</label>
                        <input type="number" id="insight" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm" placeholder="0">
                    </div>
                    <div>
                        <label for="follower" class="block text-sm font-medium text-stone-700">Follower Saat Posting</label>
                        <input type="number" id="follower" class="mt-1 block w-full border-stone-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm" placeholder="0">
                    </div>
                 </div>

                <div class="mt-6 flex items-center">
                    <input id="featured" type="checkbox" class="h-4 w-4 text-amber-600 focus:ring-amber-500 border-stone-300 rounded">
                    <label for="featured" class="ml-2 block text-sm text-stone-900">üî• Tandai sebagai Konten Unggulan</label>
                </div>
                
                <div class="flex justify-end gap-4 mt-8 border-t pt-6">
                    <button type="button" id="delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">Hapus</button>
                    <button type="submit" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 
    ================================================================
    PERUBAHAN UTAMA: FIREBASE SDK
    ================================================================
    Kode di bawah ini mengimpor library Firebase yang diperlukan.
    -->
    <script type="module">
        // Impor fungsi-fungsi yang kita butuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // PERUBAHAN: Menambahkan signInWithCustomToken
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, // Ini adalah kunci real-time
            addDoc,     // Untuk menambah data baru
            setDoc,     // Untuk mengedit data
            deleteDoc,  // Untuk menghapus data
            query,       // Untuk mengambil data
            setLogLevel // PERUBAHAN: Untuk debugging
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MULAI KONEKSI FIREBASE ---
        
        // Variabel global untuk Firebase
        let app, db, auth, userId;
        let contentCollectionRef; // Ini akan menjadi database bersama

        // 
        // PERUBAHAN: Menggunakan variabel global yang disediakan platform
        // 
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        // Fungsi ini akan berjalan pertama kali
        async function initFirebase() {
            // PERUBAHAN: Menambahkan setLogLevel untuk debug error
            setLogLevel('Debug');

            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing!");
                document.body.innerHTML = `<div style="padding: 2rem; text-align: center; background-color: #FFFBEB; color: #B45309;">
                    <h1>Connection Error</h1>
                    <p>Konfigurasi Firebase tidak ditemukan. Aplikasi tidak dapat dimuat.</p>
                </div>`;
                return;
            }

            try {
                // 1. Inisialisasi Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 2. PERUBAHAN: Masuk menggunakan token yang disediakan platform
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth); // Fallback jika token tidak ada
                }
                userId = auth.currentUser ? auth.currentUser.uid : 'anonymous_user';
                console.log("Firebase initialized, User ID:", userId);


                // 3. PERUBAHAN: Menggunakan path database publik yang benar
                // Ini adalah 'folder' bersama untuk aplikasi ini
                const dbPath = `/artifacts/${appId}/public/data/contentMaster`;
                contentCollectionRef = collection(db, dbPath);
                console.log("Connecting to Firestore path:", dbPath);

                // 4. Mulai mendengarkan perubahan data dari database
                setupSnapshotListener();
                
                // 5. Jalankan sisa logika aplikasi Anda (kalender, tabel, dll)
                initializeAppLogic();

            } catch (error) {
                console.error("Gagal inisialisasi Firebase:", error);
                // Tampilkan pesan error jika konfigurasi salah
                const body = document.querySelector('body');
                body.innerHTML = `<div style="padding: 2rem; text-align: center; background-color: #FFFBEB; color: #B45309;">
                    <h1>Connection Error</h1>
                    <p>Tidak bisa terhubung ke database. Apakah Anda sudah memasukkan <b>firebaseConfig</b> di file index.html?</p>
                    <p><i>Error: ${error.message}</i></p>
                </div>`;
            }
        }
        
        // Fungsi ini adalah KUNCI dari sinkronisasi real-time
        function setupSnapshotListener() {
            // onSnapshot 'mendengarkan' setiap perubahan di database
            onSnapshot(query(contentCollectionRef), (snapshot) => {
                const allContent = [];
                snapshot.forEach((doc) => {
                    // Masukkan data dari database + ID uniknya
                    allContent.push({ ...doc.data(), id: doc.id }); 
                });
                
                // Perbarui state lokal dengan data dari online
                if (window.appState) { // Pastikan appState sudah ada
                    window.appState.contentData = allContent;
                    // Render ulang seluruh UI dengan data baru
                    window.renderAll(); 
                }
            }, (error) => {
                console.error("Error listening to collection: ", error);
            });
        }

        // Panggil initFirebase saat halaman selesai dimuat
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
        });


        // --- LOGIKA APLIKASI ANDA (DIMODIFIKASI) ---

        // Kita buat fungsi ini global agar bisa diakses
        function initializeAppLogic() {
            
            // State sekarang tidak lagi mengambil dari localStorage
            const state = {
                currentDate: new Date(),
                contentData: [], // Dimulai kosong, akan diisi oleh Firebase
                currentTab: 'calendar',
                editingContentId: null,
            };
            // Buat state bisa diakses global
            window.appState = state;

            const options = {
                platforms: ["TikTok", "IG Feed", "IG Reels", "YT Shorts", "YT Video", "FB", "Pinterest", "X"],
                accounts: ["Akun 1", "Akun 2", "Akun 3", "Akun 4", "Akun 5", "Akun 6", "Akun 7", "Akun 8"],
                statuses: ["‚ö™ Draft", "üü° Scheduled", "üü¢ Posted", "üî¥ Failed"],
            };

            const populateSelect = (elementId, optionsArray) => {
                const select = document.getElementById(elementId);
                if (!select) return;
                select.innerHTML = '';
                if(elementId.includes('filter')) {
                    select.innerHTML = `<option value="All">Semua ${elementId.includes('platform') ? 'Platform' : 'Status'}</option>`;
                }
                optionsArray.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    select.appendChild(opt);
                });
            };

            populateSelect('platform', options.platforms);
            populateSelect('akun', options.accounts);
            populateSelect('status', options.statuses);
            populateSelect('platform-filter', options.platforms);
            populateSelect('status-filter', options.statuses.map(s => s.split(' ')[1]));

            // FUNGSI saveState() DIHAPUS, karena kita simpan langsung ke Firebase
            // const saveState = () => { ... } // <-- Dihapus

            const digitalClockEl = document.getElementById('digital-clock');
            const dateTodayEl = document.getElementById('date-today');
            
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                const dateString = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                digitalClockEl.textContent = timeString;
                dateTodayEl.textContent = dateString;
            }
            setInterval(updateClock, 1000);
            updateClock();
            
            const monthYearEl = document.getElementById('month-year');
            const calendarGridEl = document.getElementById('calendar-grid');

            function renderCalendar() {
                calendarGridEl.innerHTML = '';
                const month = state.currentDate.getMonth();
                const year = state.currentDate.getFullYear();

                monthYearEl.textContent = new Date(year, month).toLocaleDateString('id-ID', {
                    month: 'long',
                    year: 'numeric'
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const dayHeaders = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
                dayHeaders.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = "text-center font-bold text-sm text-stone-500";
                    dayEl.textContent = day;
                    calendarGridEl.appendChild(dayEl);
                });

                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyEl = document.createElement('div');
                    calendarGridEl.appendChild(emptyEl);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day border border-stone-200 p-2 h-24 rounded-md flex flex-col cursor-pointer hover:bg-amber-100 transition-colors';
                    const date = new Date(year, month, day);
                    const dateString = date.toISOString().split('T')[0];

                    const numberEl = document.createElement('span');
                    numberEl.textContent = day;
                    numberEl.className = 'font-semibold text-sm';
                    dayEl.appendChild(numberEl);

                    const eventsToday = state.contentData.filter(item => item.tanggalUpload && item.tanggalUpload.startsWith(dateString));
                    if(eventsToday.length > 0) {
                        dayEl.classList.add('has-events');
                        const eventsContainer = document.createElement('div');
                        eventsContainer.className = 'text-xs mt-1 overflow-hidden';
                        eventsToday.slice(0, 2).forEach(event => {
                             const eventEl = document.createElement('p');
                             eventEl.textContent = `${event.platform.split(' ')[0]}: ${event.title.substring(0,10)}...`;
                             eventEl.className = 'truncate';
                             eventsContainer.appendChild(eventEl);
                        });
                        if(eventsToday.length > 2) {
                            const moreEl = document.createElement('p');
                            moreEl.textContent = `+${eventsToday.length - 2} lagi`;
                            moreEl.className = 'font-bold';
                            eventsContainer.appendChild(moreEl);
                        }
                        dayEl.appendChild(eventsContainer);
                    }
                    
                    if (date.toDateString() === new Date().toDateString()) {
                        numberEl.classList.add('bg-amber-500', 'text-white', 'rounded-full', 'w-6', 'h-6', 'flex', 'items-center', 'justify-center');
                    }

                    dayEl.addEventListener('click', () => showPostsForDate(date));
                    calendarGridEl.appendChild(dayEl);
                }
            }
            
            function showPostsForDate(date) {
                const dateString = date.toISOString().split('T')[0];
                const eventsToday = state.contentData.filter(item => item.tanggalUpload && item.tanggalUpload.startsWith(dateString));
                if (eventsToday.length > 0) {
                   const contentItem = eventsToday[0];
                   openModal(contentItem);
                } else {
                   openModal(null, dateString);
                }
            }

            document.getElementById('prev-month').addEventListener('click', () => {
                state.currentDate.setMonth(state.currentDate.getMonth() - 1);
                renderAll();
            });

            document.getElementById('next-month').addEventListener('click', () => {
                state.currentDate.setMonth(state.currentDate.getMonth() + 1);
                renderAll();
            });
            
            const tableBodyEl = document.getElementById('table-body');
            function renderTable() {
                tableBodyEl.innerHTML = '';
                const platformFilter = document.getElementById('platform-filter').value;
                const statusFilter = document.getElementById('status-filter').value;

                let filteredData = state.contentData;
                if (platformFilter !== 'All') {
                    filteredData = filteredData.filter(item => item.platform === platformFilter);
                }
                if (statusFilter !== 'All') {
                    filteredData = filteredData.filter(item => item.status && item.status.includes(statusFilter));
                }
                
                filteredData.sort((a, b) => new Date(b.tanggalUpload) - new Date(a.tanggalUpload));
                
                if (filteredData.length === 0) {
                     tableBodyEl.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-stone-500">Belum ada konten.</td></tr>`;
                     return;
                }

                filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-stone-50 cursor-pointer';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-stone-900">${item.title}</div>
                            <div class="text-sm text-stone-500">${item.akun}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${item.platform}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${new Date(item.tanggalUpload).toLocaleDateString('id-ID')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(item.status)}">${item.status ? item.status.split(' ')[1] : 'N/A'}</span>
                        </td>
                    `;
                    row.addEventListener('click', () => openModal(item));
                    tableBodyEl.appendChild(row);
                });
            }

            function getStatusColor(status) {
                if (!status) return 'bg-stone-100 text-stone-800';
                if (status.includes("Posted")) return 'bg-emerald-100 text-emerald-800';
                if (status.includes("Scheduled")) return 'bg-yellow-100 text-yellow-800';
                if (status.includes("Failed")) return 'bg-red-100 text-red-800';
                return 'bg-stone-100 text-stone-800';
            }

            document.getElementById('platform-filter').addEventListener('change', renderTable);
            document.getElementById('status-filter').addEventListener('change', renderTable);
            
            const modal = document.getElementById('content-modal');
            const form = document.getElementById('content-form');

            function openModal(contentItem = null, defaultDate = null) {
                form.reset();
                // 'contentItem.id' sekarang adalah ID unik dari Firestore
                state.editingContentId = contentItem ? contentItem.id : null; 
                document.getElementById('modal-title').textContent = contentItem ? 'Edit Konten' : 'Tambah Konten Baru';
                document.getElementById('delete-btn').classList.toggle('hidden', !contentItem);

                if (contentItem) {
                    document.getElementById('content-id').value = contentItem.id;
                    document.getElementById('title').value = contentItem.title;
                    document.getElementById('platform').value = contentItem.platform;
                    document.getElementById('akun').value = contentItem.akun;
                    document.getElementById('status').value = contentItem.status;
                    document.getElementById('tanggal-upload').value = contentItem.tanggalUpload;
                    document.getElementById('file-konten').value = contentItem.fileKonten || '';
                    document.getElementById('caption').value = contentItem.caption || '';
                    document.getElementById('insight').value = contentItem.insight || '';
                    document.getElementById('follower').value = contentItem.follower || '';
                    document.getElementById('featured').checked = contentItem.featured || false;
                } else {
                     if (defaultDate) {
                         const now = new Date();
                         const defaultDateTime = `${defaultDate}T${now.toTimeString().slice(0,5)}`;
                         document.getElementById('tanggal-upload').value = defaultDateTime;
                     }
                }

                modal.classList.add('show');
            }

            function closeModal() {
                modal.classList.remove('show');
            }

            document.getElementById('add-content-btn').addEventListener('click', () => openModal());
            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // ================================================================
            // PERUBAHAN UTAMA: Form Submit
            // Fungsi ini diubah menjadi async untuk 'await' (menunggu)
            // proses simpan ke database selesai.
            // ================================================================
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Kumpulkan data dari form
                const formData = {
                    // ID tidak perlu dibuat manual lagi, Firebase yang buatkan
                    title: document.getElementById('title').value,
                    platform: document.getElementById('platform').value,
                    akun: document.getElementById('akun').value,
                    status: document.getElementById('status').value,
                    tanggalUpload: document.getElementById('tanggal-upload').value,
                    fileKonten: document.getElementById('file-konten').value,
                    caption: document.getElementById('caption').value,
                    insight: parseInt(document.getElementById('insight').value) || 0,
                    follower: parseInt(document.getElementById('follower').value) || 0,
                    featured: document.getElementById('featured').checked,
                };
                
                try {
                    if (state.editingContentId) {
                        // JIKA EDIT: Update dokumen yang ada
                        const docRef = doc(db, "contentMaster", state.editingContentId);
                        await setDoc(docRef, formData, { merge: true }); // merge: true agar aman
                    } else {
                        // JIKA BARU: Tambah dokumen baru
                        await addDoc(contentCollectionRef, formData);
                    }
                    
                    closeModal();
                    // Kita TIDAK perlu panggil renderAll() di sini.
                    // onSnapshot akan mendeteksi perubahan ini dan
                    // memanggil renderAll() secara otomatis. Ajaib!

                } catch (error) {
                    console.error("Error saving document: ", error);
                    alert("Gagal menyimpan data ke database. Coba lagi.");
                }
            });
            
            // ================================================================
            // PERUBAHAN UTAMA: Tombol Hapus
            // Juga diubah menjadi async dan menghapus `confirm()`
            // ================================================================
            document.getElementById('delete-btn').addEventListener('click', async () => {
                // `confirm()` tidak berfungsi baik di embed Notion.
                // Untuk keamanan, Anda bisa membuat modal konfirmasi kustom.
                // Untuk saat ini, kita hapus konfirmasinya agar bisa berfungsi.
                // if (confirm('Apakah Anda yakin ingin menghapus konten ini?')) { // <-- Dihapus
                    
                if (!state.editingContentId) return; // Pastikan ada ID untuk dihapus

                try {
                    const docRef = doc(db, "contentMaster", state.editingContentId);
                    await deleteDoc(docRef);
                    closeModal();
                    // Lagi, onSnapshot akan menangani update UI.
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert("Gagal menghapus data. Coba lagi.");
                }
                // }
            });

            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    state.currentTab = tabName;

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    tabPanels.forEach(panel => {
                        if (panel.id === `${tabName}-view`) {
                            panel.classList.remove('hidden');
                        } else {
                            panel.classList.add('hidden');
                        }
                    });
                    renderAll(); // Render ulang saat ganti tab
                });
            });

            let insightsChartInstance = null;
            function renderInsights() {
                const postedContent = state.contentData.filter(c => c.status && c.status.includes('Posted'));
                
                const insightsByPlatform = options.platforms.reduce((acc, platform) => {
                    acc[platform] = 0;
                    return acc;
                }, {});

                postedContent.forEach(item => {
                    if (insightsByPlatform[item.platform] !== undefined) {
                        insightsByPlatform[item.platform] += item.insight;
                    }
                });

                const chartCtx = document.getElementById('insights-chart').getContext('2d');
                if(insightsChartInstance) {
                    insightsChartInstance.destroy();
                }
                insightsChartInstance = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(insightsByPlatform),
                        datasets: [{
                            label: 'Total Insight',
                            data: Object.values(insightsByPlatform),
                            backgroundColor: 'rgba(245, 158, 11, 0.6)',
                            borderColor: 'rgba(245, 158, 11, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
                
                const featuredGallery = document.getElementById('featured-gallery');
                featuredGallery.innerHTML = '';
                const featuredContent = state.contentData.filter(c => c.featured);
                if (featuredContent.length === 0) {
                    featuredGallery.innerHTML = `<p class="col-span-full text-center text-stone-500">Belum ada konten unggulan.</p>`;
                    return;
                }
                featuredContent.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'aspect-square bg-stone-200 rounded-lg overflow-hidden cursor-pointer';
                    // Fallback image jika tidak ada link
                    const imgSrc = item.fileKonten || 'https://placehold.co/400x400/FDFBF8/b45309?text=Konten';
                    itemEl.innerHTML = `<img src="${imgSrc}" alt="${item.title}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x400/FDFBF8/b45309?text=Error';">`;
                    itemEl.addEventListener('click', () => openModal(item));
                    featuredGallery.appendChild(itemEl);
                });
            }
            
            function updateDashboardCards() {
                const todayString = new Date().toISOString().split('T')[0];
                const todayPosts = state.contentData.filter(c => c.tanggalUpload && c.tanggalUpload.startsWith(todayString));
                document.getElementById('today-post-count').textContent = todayPosts.length;

                const upcomingPosts = state.contentData.filter(c => c.tanggalUpload && c.tanggalUpload > todayString && c.status && c.status.includes('Scheduled'));
                document.getElementById('upcoming-post-count').textContent = upcomingPosts.length;
            }
            
            // Buat fungsi renderAll global
            window.renderAll = function() {
                updateDashboardCards();
                switch(state.currentTab) {
                    case 'calendar':
                        renderCalendar();
                        break;
                    case 'table':
                        renderTable();
                        break;
                    case 'insights':
                        renderInsights();
                        break;
                }
            }

            // Awalnya, renderAll() akan dipanggil oleh onSnapshot
            // tapi kita panggil sekali di sini untuk jaga-jaga
            // jika datanya masih kosong
            renderAll(); 
        }

    </script>
</body>
</html>
